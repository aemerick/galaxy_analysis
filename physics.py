import numpy as np


# from pop3_properties.F in Enzo
#
# Model lifetime used in Enzo for popIII stars. this is used to compare rates
# with the previous enzo model
#
_popIII_lifetimes = np.array([6.190e7,4.536e7,3.366e7,2.560e7,
          2.022e7,1.673e7,1.443e7,1.288e7,
          1.181e7,1.102e7,1.040e7,9.853e6,
          9.357e6,8.907e6,8.494e6,8.114e6,
          7.762e6,7.432e6,7.122e6,6.829e6,
          6.549e6,6.281e6,6.024e6,5.779e6,
          5.548e6,5.329e6,5.124e6,4.931e6,
          4.752e6,4.587e6,4.434e6,4.294e6,
          4.168e6,4.054e6,3.953e6,3.864e6,
          3.788e6,3.723e6,3.668e6,3.622e6,
          3.585e6,3.554e6,3.529e6,3.510e6,
          3.496e6,3.486e6,3.480e6,3.476e6,
          3.474e6,3.473e6,3.473e6,3.474e6,
          3.474e6,3.472e6,3.469e6,3.464e6,
          3.456e6,3.444e6,3.431e6,3.414e6,
          3.396e6,3.376e6,3.354e6,3.331e6,
          3.306e6,3.280e6,3.254e6,3.227e6,
          3.199e6,3.172e6,3.144e6,3.117e6,
          3.090e6,3.063e6,3.037e6,3.012e6,
          2.988e6,2.965e6,2.943e6,2.921e6,
          2.901e6,2.881e6,2.863e6,2.844e6,
          2.827e6,2.811e6,2.795e6,2.779e6,
          2.765e6,2.751e6,2.737e6,2.724e6,
          2.712e6,2.700e6,2.688e6,2.677e6,
          2.667e6,2.656e6,2.647e6,2.637e6,
          2.628e6,2.619e6,2.611e6,2.603e6,
          2.595e6,2.587e6,2.580e6,2.573e6,
          2.566e6,2.559e6,2.552e6,2.546e6,
          2.539e6,2.533e6,2.527e6,2.521e6,
          2.515e6,2.509e6,2.503e6,2.498e6,
          2.492e6,2.486e6,2.481e6,2.475e6,
          2.470e6,2.464e6,2.459e6,2.454e6,
          2.448e6,2.443e6,2.438e6,2.433e6,
          2.428e6,2.423e6,2.418e6,2.414e6,
          2.409e6,2.404e6,2.400e6,2.395e6,
          2.390e6,2.386e6,2.381e6,2.377e6,
          2.373e6,2.368e6,2.364e6,2.360e6,
          2.356e6,2.352e6,2.348e6,2.344e6,
          2.340e6,2.336e6,2.332e6,2.328e6,
          2.324e6,2.320e6,2.317e6,2.313e6,
          2.309e6,2.306e6,2.302e6,2.299e6,
          2.295e6,2.292e6,2.288e6,2.285e6,
          2.282e6,2.278e6,2.275e6,2.272e6,
          2.269e6,2.266e6,2.262e6,2.259e6,
          2.256e6,2.253e6,2.250e6,2.247e6,
          2.244e6,2.242e6,2.239e6,2.236e6,
          2.233e6,2.230e6,2.228e6,2.225e6,
          2.222e6,2.219e6,2.217e6,2.214e6,
          2.212e6,2.209e6,2.207e6,2.204e6,
          2.202e6,2.199e6,2.197e6,2.194e6,
          2.192e6,2.189e6,2.187e6,2.185e6,
          2.182e6,2.180e6,2.178e6,2.176e6,
          2.174e6,2.171e6,2.169e6,2.167e6,
          2.165e6,2.163e6,2.161e6,2.159e6,
          2.157e6,2.155e6,2.153e6,2.151e6,
          2.149e6,2.147e6,2.145e6,2.143e6,
          2.141e6,2.139e6,2.137e6,2.135e6,
          2.134e6,2.132e6,2.130e6,2.128e6,
          2.127e6,2.125e6,2.123e6,2.122e6,
          2.120e6,2.118e6,2.117e6,2.115e6,
          2.113e6,2.112e6,2.110e6,2.109e6,
          2.107e6,2.106e6,2.104e6,2.103e6,
          2.101e6,2.100e6,2.098e6,2.097e6,
          2.095e6,2.094e6,2.093e6,2.091e6,
          2.090e6,2.088e6,2.087e6,2.086e6,
          2.085e6,2.083e6,2.082e6,2.081e6,
          2.079e6,2.078e6,2.077e6,2.076e6,
          2.075e6,2.073e6,2.072e6,2.071e6,
          2.070e6,2.069e6,2.068e6,2.066e6,
          2.065e6,2.064e6,2.063e6,2.062e6,
          2.061e6,2.060e6,2.059e6,2.058e6,
          2.057e6,2.056e6,2.055e6,2.054e6,
          2.053e6,2.052e6,2.051e6,2.050e6,
          2.049e6,2.048e6,2.047e6,2.046e6,
          2.045e6,2.044e6,2.043e6,2.042e6,
          2.041e6,2.041e6,2.040e6,2.039e6,
          2.038e6,2.037e6,2.036e6,2.035e6,
          2.035e6,2.034e6,2.033e6,2.032e6,
          2.031e6,2.030e6,2.030e6,2.029e6,
          2.028e6,2.027e6,2.027e6,2.026e6,
          2.025e6,2.024e6,2.023e6,2.023e6,
          2.022e6,2.021e6,2.020e6,2.020e6,
          2.019e6,2.018e6,2.018e6,2.017e6,
          2.016e6,2.015e6,2.015e6,2.014e6,
          2.013e6,2.013e6,2.012e6,2.011e6,
          2.011e6,2.010e6,2.009e6,2.009e6,
          2.008e6,2.007e6,2.006e6,2.006e6,
          2.005e6,2.004e6,2.004e6,2.003e6,
          2.002e6,2.002e6,2.001e6,2.001e6,
          2.000e6,1.999e6,1.999e6,1.998e6,
          1.997e6,1.997e6,1.996e6,1.995e6,
          1.995e6,1.994e6,1.993e6,1.993e6,
          1.992e6,1.991e6,1.991e6,1.990e6,
          1.989e6,1.989e6,1.988e6,1.987e6,
          1.987e6,1.986e6,1.986e6,1.985e6,
          1.984e6,1.984e6,1.983e6,1.982e6,
          1.982e6,1.981e6,1.980e6,1.980e6,
          1.979e6,1.978e6,1.977e6,1.977e6,
          1.976e6,1.975e6,1.975e6,1.974e6,
          1.973e6,1.973e6,1.972e6,1.971e6,
          1.970e6,1.970e6,1.969e6,1.968e6,
          1.968e6,1.967e6,1.966e6,1.965e6,
          1.965e6,1.964e6,1.963e6,1.962e6,
          1.962e6,1.961e6,1.960e6,1.959e6,
          1.959e6,1.958e6,1.957e6,1.956e6,
          1.956e6,1.955e6,1.954e6,1.953e6,
          1.953e6,1.952e6,1.951e6,1.950e6,
          1.950e6,1.949e6,1.948e6,1.947e6,
          1.946e6,1.946e6,1.945e6,1.944e6,
          1.943e6,1.943e6,1.942e6,1.941e6,
          1.940e6,1.940e6,1.939e6,1.938e6,
          1.937e6,1.936e6,1.936e6,1.935e6,
          1.934e6,1.933e6,1.933e6,1.932e6,
          1.931e6,1.930e6,1.929e6,1.929e6,
          1.928e6,1.927e6,1.926e6,1.926e6,
          1.925e6,1.924e6,1.923e6,1.922e6,
          1.922e6,1.921e6,1.920e6,1.919e6,
          1.919e6,1.918e6,1.917e6,1.916e6,
          1.916e6,1.915e6,1.914e6,1.913e6,
          1.913e6,1.912e6,1.911e6,1.910e6,
          1.910e6,1.909e6,1.908e6,1.908e6,
          1.907e6,1.906e6,1.905e6,1.905e6,
          1.904e6,1.903e6,1.903e6,1.902e6,
          1.901e6,1.900e6,1.900e6,1.899e6,
          1.898e6,1.898e6,1.897e6,1.896e6,
          1.896e6,1.895e6,1.894e6,1.894e6,
          1.893e6,1.892e6,1.892e6,1.891e6,
          1.890e6,1.890e6,1.889e6,1.888e6,
          1.888e6,1.887e6,1.886e6,1.886e6,
          1.885e6,1.884e6,1.884e6,1.883e6,
          1.883e6,1.882e6,1.881e6,1.881e6,
          1.880e6,1.880e6,1.879e6,1.878e6,
          1.878e6,1.877e6,1.877e6,1.876e6,
          1.875e6,1.875e6,1.874e6,1.874e6,
          1.873e6,1.873e6,1.872e6,1.871e6,
          1.871e6,1.870e6,1.870e6,1.869e6,
          1.869e6,1.868e6,1.868e6,1.867e6,
          1.867e6,1.866e6,1.865e6,1.865e6,
          1.864e6,1.864e6,1.863e6,1.863e6,
          1.862e6,1.862e6,1.861e6,1.861e6,
          1.860e6,1.860e6,1.859e6,1.859e6,
          1.858e6,1.858e6,1.857e6,1.857e6,
          1.856e6,1.856e6,1.855e6,1.855e6,
          1.854e6,1.854e6,1.853e6,1.853e6,
          1.853e6,1.852e6,1.852e6,1.851e6,
          1.851e6,1.850e6,1.850e6,1.849e6,
          1.849e6,1.848e6,1.848e6,1.848e6,
          1.847e6,1.847e6,1.846e6,1.846e6,
          1.845e6,1.845e6,1.845e6,1.844e6,
          1.844e6,1.843e6,1.843e6,1.843e6,
          1.842e6,1.842e6,1.841e6,1.841e6,
          1.841e6,1.840e6,1.840e6,1.839e6,
          1.839e6,1.839e6,1.838e6,1.838e6,
          1.837e6,1.837e6,1.837e6,1.836e6,
          1.836e6,1.836e6,1.835e6,1.835e6,
          1.834e6,1.834e6,1.834e6,1.833e6,
          1.833e6,1.833e6,1.832e6,1.832e6,
          1.832e6,1.831e6,1.831e6,1.831e6,
          1.830e6,1.830e6,1.830e6,1.829e6,
          1.829e6,1.829e6,1.828e6,1.828e6,
          1.828e6,1.827e6,1.827e6,1.827e6,
          1.826e6,1.826e6,1.826e6,1.826e6,
          1.825e6,1.825e6,1.825e6,1.824e6,
          1.824e6,1.824e6,1.824e6,1.823e6,
          1.823e6,1.823e6,1.822e6,1.822e6,
          1.822e6,1.822e6,1.821e6,1.821e6,
          1.821e6,1.820e6,1.820e6,1.820e6,
          1.820e6,1.819e6,1.819e6,1.819e6,
          1.819e6,1.818e6,1.818e6,1.818e6,
          1.818e6,1.817e6,1.817e6,1.817e6,
          1.817e6,1.816e6,1.816e6,1.816e6,
          1.816e6,1.815e6,1.815e6,1.815e6,
          1.815e6,1.815e6,1.814e6,1.814e6,
          1.814e6,1.814e6,1.813e6,1.813e6,
          1.813e6,1.813e6,1.813e6,1.812e6,
          1.812e6,1.812e6,1.812e6,1.812e6,
          1.811e6,1.811e6,1.811e6,1.811e6,
          1.811e6,1.810e6,1.810e6,1.810e6,
          1.810e6,1.810e6,1.810e6,1.809e6,
          1.809e6,1.809e6,1.809e6,1.809e6,
          1.808e6,1.808e6,1.808e6,1.808e6,
          1.808e6,1.808e6,1.807e6,1.807e6,
          1.807e6,1.807e6,1.807e6,1.807e6,
          1.807e6,1.806e6,1.806e6,1.806e6,
          1.806e6,1.806e6,1.806e6,1.805e6,
          1.805e6,1.805e6,1.805e6,1.805e6,
          1.805e6,1.805e6,1.805e6,1.804e6,
          1.804e6,1.804e6,1.804e6,1.804e6,
          1.804e6,1.804e6,1.803e6,1.803e6,
          1.803e6,1.803e6,1.803e6,1.803e6,
          1.803e6,1.803e6,1.803e6,1.802e6,
          1.802e6,1.802e6,1.802e6,1.802e6,
          1.802e6,1.802e6,1.802e6,1.802e6,
          1.801e6,1.801e6,1.801e6,1.801e6,
          1.801e6,1.801e6,1.801e6,1.801e6,
          1.801e6,1.801e6,1.801e6,1.800e6,
          1.800e6,1.800e6,1.800e6,1.800e6,
          1.800e6,1.800e6,1.800e6,1.800e6,
          1.800e6,1.800e6,1.800e6,1.800e6,
          1.799e6,1.799e6,1.799e6,1.799e6,
          1.799e6,1.799e6,1.799e6,1.799e6,
          1.799e6,1.799e6,1.799e6,1.799e6,
          1.799e6,1.799e6,1.799e6,1.799e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.797e6,
          1.797e6,1.797e6,1.797e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.798e6,1.798e6,1.798e6,1.798e6,
          1.799e6,1.799e6,1.799e6,1.799e6,
          1.799e6,1.799e6,1.799e6,1.799e6,
          1.799e6,1.799e6,1.799e6,1.799e6,
          1.799e6,1.799e6,1.799e6,1.799e6,
          1.799e6,1.799e6,1.799e6,1.799e6,
          1.799e6,1.799e6,1.799e6,1.799e6,
          1.799e6,1.799e6,1.799e6,1.800e6,
          1.800e6,1.800e6,1.800e6,1.800e6,
          1.800e6,1.800e6,1.800e6,1.800e6,
          1.800e6,1.800e6,1.800e6,1.800e6]) # in yr
_popIII_lifetime_masses = np.linspace(5.,1000.,np.size(_popIII_lifetimes))


def popIII_lifetime(m):
    """
    Interpolate popIII lifetime masses exactly as is done in pop3_maker.F
    returns lifetime in years
    """
    if np.size(m) > 1:
        lifetimes = np.zeros(np.size(m))
        for i,mass in enumerate(m):
            lifetimes[i] = _popIII_lifetimes[np.argmin(np.abs(_popIII_lifetime_masses-mass))]
        return lifetimes
    else:
        index = np.argmin(np.abs(_popIII_lifetime_masses-m))
        return _popIII_lifetimes[index]


def chiaki_threshold(C_f, Fe_f, H_f, return_value = False):
    """
    Apply the Chiaki+2017 popIII to popII transition star threshold.
    Returns True if above this threshold (popII SF) and False if below
    (popIII).

    Using same hard-coded constants as Enzo

    If return_value is true, returns the value of 10**([C/H]-2.3) + 10**([Fe/H])
    """

    threshold = 10.0**(-5.07)

    H_abund  = H_f  / 1.00790
    C_abund  = C_f  / 12.0107
    Fe_abund = Fe_f / 55.8450

    C_H_solar = 8.43 - 12.0
    Fe_H_solar = 7.50 - 12.0

    C_over_H  = np.log10( C_abund / H_abund) - C_H_solar
    Fe_over_H = np.log10( Fe_abund / H_abund) - Fe_H_solar

    local_C_Fe = 10.0**(C_over_H-2.3) + 10.0**(Fe_over_H)

    if return_value:
        return local_C_Fe
    else:
        return local_C_Fe >= threshold
